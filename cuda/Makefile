# Adjust these to your setup
MWRAP       ?= $(HOME)/mwrap/mwrap
CUDA_ROOT   ?= /usr/local/cuda-13.1
MATLAB_ROOT ?= $(shell ls -d /usr/local/MATLAB/R* 2>/dev/null | sort | tail -n1)
NVCC        ?= $(CUDA_ROOT)/bin/nvcc
GCC         ?= g++
MEX         ?= $(MATLAB_ROOT)/bin/mex
MEXCUDA     ?= $(MATLAB_ROOT)/bin/mexcuda
MEX_NAME    ?= utils_cu
MEX_NAME    ?= lapslppot_cuda

# Try to auto-compute caps (numeric only) -> "80 89", otherwise fall back to 80.
CUDA_ARCH_DETECTED := $(shell nvidia-smi --query-gpu=compute_cap --format=csv,noheader,nounits 2>/dev/null | sed 's/\.//g' | tr ' ' '\n' | grep -E '^[0-9]+$$' | tr '\n' ' ')
CUDA_ARCH ?= $(if $(strip $(CUDA_ARCH_DETECTED)),$(strip $(CUDA_ARCH_DETECTED)),80)
GENCODE_FLAGS = $(foreach arch,$(CUDA_ARCH),-gencode arch=compute_$(arch),code=sm_$(arch))

# mexcuda is optional; if it is missing we fall back to nvcc + mex-style linking.
MEXCUDA_AVAILABLE := $(wildcard $(MEXCUDA))

NVCC_COMMON = -c --compiler-options=-D_GNU_SOURCE,-DMATLAB_MEX_FILE \
              -I"$(CUDA_ROOT)/include" \
              -I"$(MATLAB_ROOT)/extern/include" \
              -I"$(MATLAB_ROOT)/simulink/include" \
              -I"$(MATLAB_ROOT)/toolbox/parallel/gpu/extern/include/" \
              -std=c++11

NVCC_CFLAGS = $(NVCC_COMMON) $(GENCODE_FLAGS) \
              -Xcompiler "-fexceptions -fPIC -fno-omit-frame-pointer -pthread" \
              -O2 -DNDEBUG

LINK_COMMON = -pthread -Wl,--no-undefined -Wl,--no-as-needed -shared -O \
              -Wl,--version-script,"$(MATLAB_ROOT)/extern/lib/glnxa64/mexFunction.map" \
              -ldl \
              -L$(CUDA_ROOT)/lib64 -lcudart -Wl,-rpath,$(CUDA_ROOT)/lib64 \
              -L"$(MATLAB_ROOT)/bin/glnxa64" -Wl,-rpath-link,$(MATLAB_ROOT)/bin/glnxa64 \
              -lmx -lmex -lmat -lmwgpu -lm

# Generated sources from mwrap (kept in repo; regenerate only if utils_cu.mw changes)
WRAP_SRCS = utils_cu.cu utils_cu.m

all: $(MEX_NAME).mexa64

# Build the mex using mexcuda, compiling both:
#   - lapslppot_wrap.cu  (gateway generated by mwrap)
#   - lapslppot.cu       (your CUDA implementation with lapslppot())
$(MEX_NAME).mexa64: utils_cu.cu lapslppot.cu
ifdef MEXCUDA_AVAILABLE
	$(MEXCUDA) -v $(GENCODE_FLAGS) \
	  -I"$(MATLAB_ROOT)/toolbox/parallel/gpu/extern/include" \
	  utils_cu.cu lapslppot.cu \
	  -output $(MEX_NAME)
else
	$(NVCC) $(NVCC_CFLAGS) utils_cu.cu -o utils_cu.o
	$(NVCC) $(NVCC_CFLAGS) lapslppot.cu      -o lapslppot.o
	$(GCC) $(LINK_COMMON) utils_cu.o lapslppot.o -o $(MEX_NAME).mexa64
endif

# Regenerate wrapper sources if lapslppot.mw changes; review diffs afterward.
regen:
	$(MWRAP) -gpu -list -mb -mex utils_cu -c utils_cu.cu utils_cu.mw
	@echo "Regenerated utils_cu.cu/.m; ensure prototype include and GPU return are still correct."

clean:
	rm -f *.o *.mexa64
.PHONY: all clean
